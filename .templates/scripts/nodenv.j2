#!/bin/bash

NODE_VERSION="{{ tools.node-stable.version }} {{tools.node-latest.version}}"
NODENV_ROOT=${HOME}/.nodenv
PATH=${NODENV_ROOT}/bin:${PATH}

_preprocess() {
  sudo apt-get update
  sudo apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev \
    libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
    xz-utils tk-dev libffi-dev liblzma-dev python-openssl git

  git clone "https://github.com/nodenv/nodenv.git" ${NODENV_ROOT}
  echo 'export NODENV_ROOT="${HOME}/.nodenv"' >> ${HOME}/.bashrc
  echo 'export PATH="${NODENV_ROOT}/bin:${PATH}"' >> ${HOME}/.bashrc
  echo 'eval "$(nodenv init -)"' >> ${HOME}/.bashrc
  . ${HOME}/.bashrc
}
_node(){
  nodenv install ${NODE_VERSION}
}
_postprocess(){
  nodenv global ${NODE_VERSION}
  nodenv rehash
}


if [ ! -e ${NODENV_ROOT} ]; then
  _preprocess
else
  echo "[!] nodenv is already installed. Skipped."
fi
if [ ! -e ${NODENV_ROOT}/shims/node${NODE_VERSION%.*} ]; then
  _node
else
  echo "[!] Python ${NODE_VERSION} is already installed. Skipped."
fi

_postprocess
